syntax = "proto3";
package fitglue;

import "google/protobuf/timestamp.proto";

option go_package = "fitglue/pkg/shared/pb";

message UserRecord {
  string user_id = 1;
  google.protobuf.Timestamp created_at = 2;
  UserIntegrations integrations = 3;
  // Pipelines define the data flow: Source -> Enrichers -> Routing
  repeated PipelineConfig pipelines = 4;
}

message PipelineConfig {
  string id = 1; // Unique ID (uuid) for tracing
  string source = 2; // e.g. "SOURCE_HEVY"
  repeated EnricherConfig enrichers = 3;
  repeated string destinations = 4; // e.g. ["strava", "gcs"]
}

message UserIntegrations {
  HevyIntegration hevy = 1;
  FitbitIntegration fitbit = 2;
  StravaIntegration strava = 3;
  KeiserIntegration keiser = 4;
}


message HevyIntegration {
  bool enabled = 1;
  string api_key = 2;
  string user_id = 3;
}

message FitbitIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string fitbit_user_id = 5;
}

message SourceEnrichmentConfig {
  repeated EnricherConfig enrichers = 1;
}

message EnricherConfig {
  string name = 1; // e.g. "ai-description", "fitbit-hr"
  map<string, string> inputs = 2; // e.g. {"prompt_style": "funny", "priority": "high"}
}

message StravaIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    int64 athlete_id = 5;
}

message KeiserIntegration {
  bool enabled = 1;
  string auth_provider = 2;  // 'email', 'facebook', 'google', 'apple'
  string refresh_token = 3;
  google.protobuf.Timestamp refresh_token_expires_at = 4;
  string encrypted_credentials = 5;  // Only for 'email' provider (AES-256-GCM encrypted JSON)
  bool requires_reauth = 6;  // Set to true when OAuth token expires and cannot auto-refresh
}
